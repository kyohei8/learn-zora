# Zore Protocol

## アーキテクチャ

本プロトコルは、ERC-721 NFT標準を拡張したものであり、各NFTのために市場における入札の形で流動性の統一されたプールを提供することを目的としています。本プロトコルでは、NFT をメディアと呼びます。

本プロトコルの役割と方法は、以下のようにコアコントラクトと相互作用する。

![img](https://raw.githubusercontent.com/ourzora/core/master/architecture.png)

### 構造体の定義

```cs
// Decimal.D256
struct D256 {
  uint256 value;
}

struct Bid {
  // 入札通貨の金額
  uint256 amount;
  // 入札に使用するERC20トークンのアドレス
  address currency;
  // 入札者のアドレス
  address bidder;
  // 受取人のアドレス
  address recipient;
  // 次の販売における前所有者が受け取る割合(%)
  Decimal.D256 sellOnShare;
}

struct Ask {
  // 入札通貨の金額
  uint256 amount;
  // 入札に使用するERC20トークンのアドレス
  address currency;
  // 次の販売における前所有者が受け取る割合(%)
  Decimal.D256 sellOnShare;
}

// 売却価格の割合（合計して100になる必要がある）
struct BidShares {
  // 前所有者への売却価格の割合(%)
  Decimal.D256 prevOwner;
  // 作成者への売却価格の割合(%)
  Decimal.D256 creator;
  // 売主（現所有者）への売却額の割合(%)
  Decimal.D256 owner;
}

// 鋳造するデータ
struct MediaData {
  // このトークンで表されるコンテンツの有効なURI
  string tokenURI;
  // このトークンに関連付けられたメタデータの有効なURI
  string metadataURI;
  // tokenURIが指すコンテンツのSHA256ハッシュ（整合性のチェック）
  bytes32 contentHash;
  // metadataURIが指すコンテンツのSHA256ハッシュ
  bytes32 metadataHash;
}

struct EIP712Signature {
  uint256 deadline;
  uint8 v;
  bytes32 r;
  bytes32 s;
}
```

## Mint(鋳造)

クリエイターはいつでも新しいメディアを作成できる。
作品が鋳造されると、新しいメディアが作成者に転送され、市場が形成される。

## Set Bid(入札)

Mintされたトークンには誰でも入札することができる。
入札することで、入札者は自分で選択した通貨を市場契約に入金する。
入札には、有効なERC-20の通貨を使用することができる。
AMPL、YAM、BASEDのようなリベース可能な通貨を使用して入札しないことを強くお勧めします。

## Remove Bid(入札の取り消し)

入札者が入札を設定すると、それを削除することができる。
メディアへの入札を削除するには、入札者が入札を削除したいメディアを指定するだけ。
メディア1つにつき入札者は1つの入札しか設定できない。(1メディアに対して同じ人が複数入札はできない)

## Transfer（譲渡）

メディアの所有者は誰でも、指定したアドレスにメディアを転送(譲渡)できる。
メディアの市場が変わらないが、メディアにAskがある場合はそれを削除される。（？）
Zoraプロトコルの実装は標準のERC721規格から変更していない。

## Burn（取引の停止）

Zoraプロトコルは、メディアの所有者が作成者でもある場合に限り、メディアをBurnすることが可能。
BurnされてもメディアのtokenURIとmetadataURIは削除されない。これは、マーケットが非アクティブになっても、メディアは閲覧可能であることを意味する。事実上、メディアは**読み取り専用**になる。Burnされる前の入札は、削除することができる。

## Set Ask（売値の指定）

所有者はいつでも自分のメディアに売値を設定することができます。
売値は、Askのパラメータを満たしていれば、自動的に入札を成立させる役割を果たす。
これにより、コレクターは所有者が明示的に入札を受け入れるのを待つことなく、任意で作品を購入することができる。

## Accept Bid(入札の確定)

所有者の満足のいく入札が合った場合、所有者はそれを受け入れ、作品の所有権を入札者(受取人)に譲渡することができる。
入札の資金は、作品のbid sharesで定義された割合に応じて分配される。
入札には落札手数料が含まれている場合があることに注意する。この手数料は、メディアの次の販売の一部を売り手に渡ることになる。
例えば、誰かがそれを促進するための限られた手段で作品を所有していると仮定します。この場合、それは低い初期資本のために高く評価されたプラットフォームからの入札を受け入れることが有利であるかもしれませんが、高い潜在的な再販手数料。料金の販売で容易に悪意を持つ入札者によって避けることができるので、それは所有者が唯一の評判の良いバイヤーからの料金の提供で販売を受け入れることが示唆される。（不正防止のことだと思う。。要解読）

## Approve（代理人の許可）

メディアの所有者は、いつでも、そのメディアを代行する別の人（アドレス）を承認することができる。
この実装はERC-721標準から変更されていない。しかし、承認されたアドレスは、入札の受け入れ、リクエストの設定、URIの更新、 メディアの書き込み(上記のように、所有者が作成者であることを条件とする)もできるようになっている。

## Update Token and Media URI（トークンとメディアURIの更新）

Zoraプロトコルはメディアの永久市場を維持するように設計されているが、そのメディアのデータ利用可能性は範囲外と考えられる。しかし、データを指すURIが変更されなければならない場合、Zoraプロトコルはそれらを更新する機能を提供している。
トークンをMintする際に、完全性チェックのためにコンテンツとメタデータの sha256 ハッシュが提供されているのはURIが変更された場合、誰でもメディアの整合性をチェックすることができるためである。

このプロトコルは、トークンURIがEIPで定義されている有効なERC721メタデータJSONスキーマを指していないという点で、ERC-721とは異なる。tokenURIを更新する際の整合性チェックをサポートするために、メディアのコンテンツとメタデータは、それぞれtokenURIとmetadataURIに分割される。この分割により、整合性チェックを維持しつつ、コンテンツとメタデータの両方の URI を効果的に再構成することが可能となる。

## Metadata JSON schema

誰でも好きなようにこのプロトコルを使用できるようにするために、このプロトコルで使用される単一のメタデータJSONスキーマはありません。しかし、誰もがカスタムメタデータをサポートできるようにするために、開発者が有効なJSONスキーマを[Media Metadata Schemas Repository](https://github.com/ourzora/media-metadata-schemas)に提出することが強く推奨されている。
JSONメタデータの唯一の必須キーはバージョンであり、これは<name-calVersion>形式の文字列である(例: zora-2021010101)。このキーは、どのメタデータスキーマをサポートするかを決定するためにプラットフォームを実装する際に使用することができる。

JSONスキーマは以下のような感じ

```json
  {
    "version": "zora-20210101",
    "name": "randomName",
    "description": "randomDescription",
    "mimeType": "mimeType",
  }
```

## Permit(サードパーティによるZoraプロトコルの利用許可)

第三者がユーザーに代わってZoraプロトコルと対話するためのサポートを提供するために、型付きデータ構造に署名するためのEIP-712規格がサポートされています。Zoraプロトコルでは、ERC-20通貨ではなくNFTをサポートするためにいくつかの調整を加え、EIP-2612をベースにした許可方式を提供しています。`Permit` EIP-712のデータ構造は以下の通りです。

```js
{
  Permit: [
    { name: 'spender', type: 'address' },
    { name: 'tokenId', type: 'uint256' },
    { name: 'nonce', type: 'uint256' },
    { name: 'deadline', type: 'uint256' },
  ];
}
```

許可が申請されると、指定されたspender(支出者)がSigner(署名者)に承認されたものとして設定されます。
許可が取り消されるまでは、指定されたspender(支出者)は承認されたままであることに注意。

## Mint With Signature（署名付きMint）

メディアがまだMintされていない場合、クリエイターはMintWithSigオブジェクトに署名することで、第三者が自分に代わってMintすることを許可することができます。構造は以下の通りです。

```js
{
  MintWithSig: [
    { name: 'tokenURI', type: 'string' },
    { name: 'metadataURI', type: 'string' },
    { name: 'creatorShare', type: 'uint256' },
    { name: 'nonce', type: 'uint256' },
    { name: 'deadline', type: 'uint256' },
  ];
}
```
